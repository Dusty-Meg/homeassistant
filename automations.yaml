#################################################################
## Automations
#################################################################

        ##########################################################
        ## Sonos - Good morning - Weekday
        ##########################################################
        
- alias: Notification Audio - Good morning weekday
  trigger:
    - platform: time
      at: '06:45:00'
  condition:
      condition: and
      conditions:
        - condition: time
          weekday:
            - mon
            - tue
            - wed
            - thu
            - fri
        - condition: state
          entity_id: group.household
          state: 'home'
        - condition: state
          entity_id: input_boolean.disable_voice_greeting
          state: 'off'    
  action:
    - delay: '00:00:30'
    - service: script.turn_on
      entity_id: script.good_morning 
      
        ##########################################################
        ## Sonos - Good morning - Weekend
        ##########################################################
        
- alias: Notification Audio - Good morning weekend
  trigger:
    - platform: time
      at: '08:20:00'
  condition:
      condition: and
      conditions:
        - condition: time
          weekday:
            - sat
            - sun
        - condition: state
          entity_id: group.household
          state: 'home'
        - condition: state
          entity_id: input_boolean.disable_voice_greeting
          state: 'off'    
  action:
    - delay: '00:00:30'
    - service: script.turn_on
      entity_id: script.good_morning 
      
        ##########################################################
        ## Sonos - Turn on exterior lights
        ##########################################################
        
- alias: Notification Audio - Turn on exterior lights
  trigger:
    - platform: sun
      event: sunset
      offset: "-00:05:00"
  condition:
    - condition: state
      entity_id: input_boolean.disable_voice_greeting
      state: 'off'
    - condition: state
      entity_id: group.household
      state: 'home'  
  action:
    - delay: '00:00:30'
    - service: script.turn_on
      entity_id: script.dark_outside 

        ##########################################################
        ## Sonos - Welcome Home
        ##########################################################
        
- alias: Notification Audio - Welcome Home USER1
  trigger:
    - platform: state
      entity_id: device_tracker.USER1DEVICE
      from: 'not_home'
      to: 'home'
  condition:
    - condition: time
      after: '08:00'
      before: '19:00'
    - condition: state
      entity_id: input_boolean.disable_voice_greeting
      state: 'off'
    - condition: state
      entity_id: input_boolean.USER1_greeting
      state: 'on'
  action:
    - delay: '00:00:30'
    - service: script.turn_on
      entity_id: script.say
      data:
        variables:
          master: 'media_player.kitchen'
          where: 'media_player.kitchen, media_player.chalkboard_room, media_player.loft'
          volume: '.5'
          what: 'Welcome home USER1.'
    - delay: '00:01:00'
    - service: homeassistant.turn_off
      entity_id: input_boolean.USER1_greeting
          
- alias: Notification Audio - Welcome Home USER2
  trigger:
    - platform: state
      entity_id: device_tracker.USER2DEVICE
      from: 'not_home'
      to: 'home'
  condition:
    - condition: time
      after: '08:00'
      before: '19:00'
    - condition: state
      entity_id: input_boolean.USER2_greeting
      state: 'on'
    - condition: state
      entity_id: input_boolean.disable_voice_greeting
      state: 'off'
  action:
    - delay: '00:01:30'
    - service: script.turn_on
      entity_id: script.say
      data:
        variables:
          master: 'media_player.kitchen'
          where: 'media_player.kitchen, media_player.chalkboard_room, media_player.loft'
          volume: '.5'
          what: 'Welcome home USER2.'       
    - delay: '00:01:00'
    - service: homeassistant.turn_off
      entity_id: input_boolean.USER2_greeting

        ##########################################################
        ## Sonos - USER2 has arrived at work
        ##########################################################
        
- alias: Notification Audio - USER2 arrived at work
  trigger:
    - platform: state
      entity_id: device_tracker.USER2DEVICE
      from: 'not_home'
      to: 'Work'
  condition:
    - condition: state
      entity_id: device_tracker.USER1DEVICE
      state: 'home'
    - condition: time
      after: '07:00'
      before: '09:00'
    - condition: state
      entity_id: input_boolean.disable_voice_greeting
      state: 'off'    
  action:
    - delay: '00:00:30'
    - service: script.turn_on
      entity_id: script.say
      data:
        variables:
          master: 'media_player.kitchen'
          where: 'media_player.kitchen, media_player.chalkboard_room, media_player.loft'
          volume: '.6'
          what: 'USER2 has arrived at work.'    

        ##########################################################
        ## Sonos - USER2 Left Work to REDACTED
        ##########################################################
        
- alias: Notification Audio - USER2 Left Work
  trigger:
    - platform: state
      entity_id: device_tracker.USER2DEVICE
      from: 'Work'
      to: 'not_home'
  condition:
    - condition: state
      entity_id: device_tracker.USER1DEVICE
      state: 'home'
    - condition: time
      after: '15:00'
      before: '18:00'
    - condition: state
      entity_id: input_boolean.disable_voice_greeting
      state: 'off'    
  action:
    - service: media_player.sonos_snapshot
      data:
        with_group: yes
    - delay: '00:00:03'
    - service: media_player.sonos_unjoin
      entity_id:
        - media_player.kitchen
        - media_player.chalkboard_room
        - media_player.loft
    - delay: '00:00:01'
    - service: media_player.sonos_join
      data:
        master: media_player.kitchen
      entity_id:
        - media_player.kitchen
        - media_player.chalkboard_room
        - media_player.loft
    - delay: '00:00:01'
    - service: media_player.volume_set
      entity_id:
        - media_player.kitchen
        - media_player.chalkboard_room
        - media_player.loft
      data:
        volume_level: '.6'
    - delay: '00:00:02'
    - service: tts.google_say
      data_template:
        entity_id:
          - media_player.kitchen
          - media_player.chalkboard_room
          - media_player.loft
        message: "USER2 has left work and will arrive at REDACTED REDACTED in about {{states('sensor.USER2_to_REDACTED')}} minutes"
    - delay: '00:00:25'
    - service: media_player.sonos_restore
      data:
        with_group: yes
        
        ##########################################################
        ## Sonos - USER2 Arrived REDACTED
        ##########################################################
        
- alias: Notification Audio - USER2 Arrived REDACTED
  trigger:
    - platform: state
      entity_id: device_tracker.USER2DEVICE
      from: 'not_home'
      to: 'REDACTED'
  condition:
    - condition: state
      entity_id: device_tracker.USER1DEVICE
      state: 'home'
    - condition: time
      after: '13:00'
      before: '18:00'
    - condition: state
      entity_id: input_boolean.disable_voice_greeting
      state: 'off'    
  action:
    - delay: '00:00:30'
    - service: script.turn_on
      entity_id: script.say
      data:
        variables:
          master: 'media_player.kitchen'
          where: 'media_player.kitchen, media_player.chalkboard_room, media_player.loft'
          volume: '.6'
          what: 'USER2 has arrived at REDACTED REDACTED.' 
        
        ##########################################################
        ## Sonos - USER2 Left REDACTED to REDACTED
        ##########################################################
        
- alias: Notification Audio - USER2 Left REDACTED to REDACTED
  trigger:
    - platform: state
      entity_id: device_tracker.USER2DEVICE
      from: 'REDACTED'
      to: 'not_home'
  condition:
    - condition: state
      entity_id: device_tracker.USER1DEVICE
      state: 'home'
    - condition: time
      after: '13:00'
      before: '18:00'
    - condition: state
      entity_id: input_boolean.disable_voice_greeting
      state: 'off'    
  action:
    - service: media_player.sonos_snapshot
      data:
        with_group: yes
    - delay: '00:00:03'
    - service: media_player.sonos_unjoin
      entity_id:
        - media_player.kitchen
        - media_player.chalkboard_room
        - media_player.loft
    - delay: '00:00:01'
    - service: media_player.sonos_join
      data:
        master: media_player.kitchen
      entity_id:
        - media_player.kitchen
        - media_player.chalkboard_room
        - media_player.loft
    - delay: '00:00:01'
    - service: media_player.volume_set
      entity_id:
        - media_player.kitchen
        - media_player.chalkboard_room
        - media_player.loft
      data:
        volume_level: '.6'
    - delay: '00:00:02'
    - service: tts.google_say
      data_template:
        entity_id:
          - media_player.kitchen
          - media_player.chalkboard_room
          - media_player.loft
        message: "USER2 has left REDACTED REDACTED and will arrive at REDACTED REDACTED in about {{states('sensor.USER2_to_REDACTED')}} minutes"
    - delay: '00:00:25'
    - service: media_player.sonos_restore
      data:
        with_group: yes
        
        ##########################################################
        ## Sonos - USER2 Arrived REDACTED
        ##########################################################
        
- alias: Notification Audio - USER2 Arrived REDACTED
  trigger:
    - platform: state
      entity_id: device_tracker.USER2DEVICE
      from: 'not_home'
      to: 'REDACTED'
  condition:
    - condition: state
      entity_id: device_tracker.USER1DEVICE
      state: 'home'
    - condition: time
      after: '13:00'
      before: '18:00'
    - condition: state
      entity_id: input_boolean.disable_voice_greeting
      state: 'off'    
  action:
    - delay: '00:00:30'
    - service: script.turn_on
      entity_id: script.say
      data:
        variables:
          master: 'media_player.kitchen'
          where: 'media_player.kitchen, media_player.chalkboard_room, media_player.loft'
          volume: '.6'
          what: 'USER2 has arrived at REDACTED school.' 
        
        ##########################################################
        ## Sonos - USER2 Left REDACTED to Home
        ##########################################################
        
- alias: Notification Audio - REDACTED to Home
  trigger:
    - platform: state
      entity_id: device_tracker.USER2DEVICE
      from: 'REDACTED'
      to: 'not_home'
  condition:
    - condition: state
      entity_id: device_tracker.USER1DEVICE
      state: 'home'
    - condition: time
      after: '13:00'
      before: '18:00'
    - condition: state
      entity_id: input_boolean.disable_voice_greeting
      state: 'off'    
  action:
    - service: media_player.sonos_snapshot
      data:
        with_group: yes
    - delay: '00:00:03'
    - service: media_player.sonos_unjoin
      entity_id:
        - media_player.kitchen
        - media_player.chalkboard_room
        - media_player.loft
    - delay: '00:00:01'
    - service: media_player.sonos_join
      data:
        master: media_player.kitchen
      entity_id:
        - media_player.kitchen
        - media_player.chalkboard_room
        - media_player.loft
    - delay: '00:00:01'
    - service: media_player.volume_set
      entity_id:
        - media_player.kitchen
        - media_player.chalkboard_room
        - media_player.loft
      data:
        volume_level: '.6'
    - delay: '00:00:02'
    - service: tts.google_say
      data_template:
        entity_id:
          - media_player.kitchen
          - media_player.chalkboard_room
          - media_player.loft
        message: "USER2 has left REDACTED REDACTED and will arrive home in about {{states('sensor.USER2_to_home')}} minutes"
    - delay: '00:00:25'
    - service: media_player.sonos_restore
      data:
        with_group: yes
      
        ##########################################################
        ## Set USER1 Away after 2 Min
        ##########################################################

- alias: Location - Set USER1 Away after 2 Mins

  trigger:
    - platform: state
      entity_id: device_tracker.USER1DEVICE
      from: 'home'
      to: 'not_home'
      for:
        hours: 0
        minutes: 2
        seconds: 0

  action:
    - service: homeassistant.turn_on
      entity_id:
        - input_boolean.USER1_greeting
        - input_boolean.USER1_away
        
        ##########################################################
        ## Set USER2 Away after 2 Min
        ##########################################################

- alias: Location - Set USER2 Away after 2 Mins

  trigger:
    - platform: state
      entity_id: device_tracker.USER2DEVICE
      from: 'home'
      to: 'not_home'
      for:
        hours: 0
        minutes: 2
        seconds: 0

  action:
    - service: homeassistant.turn_on
      entity_id:
        - input_boolean.USER2_greeting
        - input_boolean.USER2_away

        ##########################################################
        ## Set USER1 Home after 10 Mins
        ##########################################################

- alias: Location - Set USER1 Home after 10 Mins

  trigger:
    - platform: state
      entity_id: device_tracker.USER1DEVICE
      from: 'not_home'
      to: 'home'
      for:
        hours: 0
        minutes: 10
        seconds: 0

  action:
    - service: homeassistant.turn_off
      entity_id:
        - input_boolean.USER1_away
        - input_boolean.USER1_away_driving
        - input_boolean.USER1_greeting  

        ##########################################################
        ## Set USER2 Home after 10 Mins
        ##########################################################

- alias: Location - Set USER2 Home after 10 Mins

  trigger:
    - platform: state
      entity_id: device_tracker.USER2DEVICE
      from: 'not_home'
      to: 'home'
      for:
        hours: 0
        minutes: 10
        seconds: 0

  action:
    - service: homeassistant.turn_off
      entity_id:
        - input_boolean.USER2_away
        - input_boolean.USER2_away_driving
        - input_boolean.USER2_greeting   

        ##########################################################
        ## Set USER1 Away Driving
        ##########################################################

- alias: Location - Set USER1 Away Driving

  trigger:
    - platform: state
      entity_id: device_tracker.USER1DEVICE
      from: 'home'
      to: 'not_home'

  condition:
    - condition: state
      entity_id: input_boolean.garage_occupancy
      state: 'on'

  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.USER1_away_driving 

        ##########################################################
        ## Set USER2 Away Driving
        ##########################################################

- alias: Location - Set USER2 Away Driving

  trigger:
    - platform: state
      entity_id: device_tracker.USER2DEVICE
      from: 'home'
      to: 'not_home'

  condition:
    - condition: state
      entity_id: input_boolean.garage_occupancy
      state: 'on'

  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.USER2_away_driving      

        ##########################################################
        ## Manually Set USER1 Away
        ##########################################################

- alias: Location - Manually Set USER1 Away

  trigger:
    - platform: state
      entity_id: input_boolean.manual_USER1_away
      from: 'off'
      to: 'on'

  action:
    - service: device_tracker.see
      data:
        dev_id: USER1DEVICE
        location_name: 'not_home'

        ##########################################################
        ## Reset Manually Set USER1 Away Switch
        ##########################################################

- alias: Location - Reset Manually Set USER1 Away

  trigger:
    - platform: state
      entity_id: input_boolean.manual_USER1_away
      from: 'off'
      to: 'on'
      for:
        hours: 0
        minutes: 0
        seconds: 30

  action:
    - service: homeassistant.turn_off
      entity_id: input_boolean.manual_USER1_away  

        ##########################################################
        ## Manually Set USER2 Away
        ##########################################################

- alias: Location - Manually Set USER2 Away

  trigger:
    - platform: state
      entity_id: input_boolean.manual_USER2_away
      from: 'off'
      to: 'on'

  action:
    - service: device_tracker.see
      data:
        dev_id: USER2DEVICE
        location_name: 'not_home'

        ##########################################################
        ## Reset Manually Set USER2 Away Switch
        ##########################################################

- alias: Location - Reset Manually Set USER2 Away

  trigger:
    - platform: state
      entity_id: input_boolean.manual_USER2_away
      from: 'off'
      to: 'on'
      for:
        hours: 0
        minutes: 0
        seconds: 30

  action:
    - service: homeassistant.turn_off
      entity_id: input_boolean.manual_USER2_away   

        ##########################################################
        ## Manually Set USER1 Home
        ##########################################################

- alias: Location - Manually Set USER1 Home

  trigger:
    - platform: state
      entity_id: input_boolean.manual_USER1_home
      from: 'off'
      to: 'on'

  action:
    - service: device_tracker.see
      data:
        dev_id: USER1DEVICE
        location_name: 'home'

        ##########################################################
        ## Reset Manually Set USER1 Home Switch
        ##########################################################

- alias: Location - Reset USER1 Home

  trigger:
    - platform: state
      entity_id: input_boolean.manual_USER1_home
      from: 'off'
      to: 'on'
      for:
        hours: 0
        minutes: 0
        seconds: 30

  action:
    - service: homeassistant.turn_off
      entity_id: input_boolean.manual_USER1_home   

        ##########################################################
        ## Manually Set USER2 Home
        ##########################################################

- alias: Location - Manually Set USER2 Home

  trigger:
    - platform: state
      entity_id: input_boolean.manual_USER2_home
      from: 'off'
      to: 'on'

  action:
    - service: device_tracker.see
      data:
        dev_id: USER2DEVICE
        location_name: 'home'

        ##########################################################
        ## Reset Manually Set USER2 Home Switch
        ##########################################################

- alias: Location - Reset USER2 Home

  trigger:
    - platform: state
      entity_id: input_boolean.manual_USER2_home
      from: 'off'
      to: 'on'
      for:
        hours: 0
        minutes: 0
        seconds: 30

  action:
    - service: homeassistant.turn_off
      entity_id: input_boolean.manual_USER2_home      
        
        ##########################################################
        ## Reset Sonos Every Morning
        ##########################################################

- alias: Media - Reset Sonos Every Morning

  trigger:
    - platform: time
      at: '06:00'

  action:
    - service: media_player.sonos_unjoin
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
    - service: homeassistant.turn_off
      entity_id:
        - input_boolean.90_station
        - input_boolean.classical_station
        - input_boolean.kids_station
        - input_boolean.jazz_station
        - input_boolean.hiphop_station
        - input_boolean.pop_station
        - input_boolean.jazz_station
        - input_boolean.caffeine_playlist
        - input_boolean.coffee_shop_playlist
        - input_boolean.dubstep_playlist
        - input_boolean.group_all_sonos
    - service: input_select.select_option
      data:
        entity_id: input_select.sonos
        option: "None"
        
        ##########################################################
        ## Group All Sonos
        ##########################################################

- alias: Media - Group All Sonos

  trigger:
    - platform: state
      entity_id: input_boolean.group_all_sonos
      from: 'off'
      to: 'on'

  condition:
    - condition: state
      entity_id: group.household
      state: 'home'

  action:
    - service: media_player.sonos_join
      data:
        master: media_player.chalkboard_room
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
        
        ##########################################################
        ## Play All '90s Station
        ##########################################################

- alias: Media - Play All '90s Station

  trigger:
    - platform: state
      entity_id: input_boolean.90_station
      from: 'off'
      to: 'on'

  condition:
    - condition: state
      entity_id: group.household
      state: 'home'

  action:
    - service: media_player.sonos_join
      data:
        master: media_player.chalkboard_room
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
    - delay: '00:00:02'
    - service: media_player.volume_set
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
      data:
        volume_level: '.4'
    - delay: '00:00:01'
    - service: media_player.select_source
      data:
        entity_id: media_player.chalkboard_room
        source: "All '90s"
    - service: homeassistant.turn_off
      entity_id:
        - input_boolean.classical_station
        - input_boolean.kids_station
        - input_boolean.jazz_station
        - input_boolean.hiphop_station
        - input_boolean.pop_station
        - input_boolean.caffeine_playlist
        - input_boolean.coffee_shop_playlist
        - input_boolean.dubstep_playlist
    - service: input_select.select_option
      data:
        entity_id: input_select.sonos
        option: "Play All '90s Station"
        
        ##########################################################
        ## Play Classical Station
        ##########################################################

- alias: Media - Play Classical Station

  trigger:
    - platform: state
      entity_id: input_boolean.classical_station
      from: 'off'
      to: 'on'

  condition:
    - condition: state
      entity_id: group.household
      state: 'home'

  action:
    - service: media_player.sonos_join
      data:
        master: media_player.chalkboard_room
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
    - delay: '00:00:02'
    - service: media_player.volume_set
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
      data:
        volume_level: '.4'
    - delay: '00:00:01'
    - service: media_player.select_source
      data:
        entity_id: media_player.chalkboard_room
        source: 'All Classical'
    - service: homeassistant.turn_off
      entity_id:
        - input_boolean.90_station
        - input_boolean.kids_station
        - input_boolean.jazz_station
        - input_boolean.hiphop_station
        - input_boolean.pop_station
        - input_boolean.caffeine_playlist
        - input_boolean.coffee_shop_playlist
        - input_boolean.dubstep_playlist
    - service: input_select.select_option
      data:
        entity_id: input_select.sonos
        option: "Play Classical Station"
        
        ##########################################################
        ## Play Little Kids Station
        ##########################################################

- alias: Media - Play Little Kids Station

  trigger:
    - platform: state
      entity_id: input_boolean.kids_station
      from: 'off'
      to: 'on'

  condition:
    - condition: state
      entity_id: group.household
      state: 'home'

  action:
    - service: media_player.sonos_join
      data:
        master: media_player.chalkboard_room
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
    - delay: '00:00:02'
    - service: media_player.volume_set
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
      data:
        volume_level: '.4'
    - delay: '00:00:01'
    - service: media_player.select_source
      data:
        entity_id: media_player.chalkboard_room
        source: "Little Kids' Music"
    - service: homeassistant.turn_off
      entity_id:
        - input_boolean.90_station
        - input_boolean.classical_station
        - input_boolean.jazz_station
        - input_boolean.hiphop_station
        - input_boolean.pop_station
        - input_boolean.caffeine_playlist
        - input_boolean.coffee_shop_playlist
        - input_boolean.dubstep_playlist
    - service: input_select.select_option
      data:
        entity_id: input_select.sonos
        option: "Play Little Kids Station"
        
        ##########################################################
        ## Play Smooth Jazz Station
        ##########################################################

- alias: Media - Play Smooth Jazz Station

  trigger:
    - platform: state
      entity_id: input_boolean.jazz_station
      from: 'off'
      to: 'on'

  condition:
    - condition: state
      entity_id: group.household
      state: 'home'

  action:
    - service: media_player.sonos_join
      data:
        master: media_player.chalkboard_room
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
    - delay: '00:00:02'
    - service: media_player.volume_set
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
      data:
        volume_level: '.4'
    - delay: '00:00:01'
    - service: media_player.select_source
      data:
        entity_id: media_player.chalkboard_room
        source: 'Smooth Jazz'
    - service: homeassistant.turn_off
      entity_id:
        - input_boolean.90_station
        - input_boolean.classical_station
        - input_boolean.kids_station
        - input_boolean.hiphop_station
        - input_boolean.pop_station
        - input_boolean.caffeine_playlist
        - input_boolean.coffee_shop_playlist
        - input_boolean.dubstep_playlist
    - service: input_select.select_option
      data:
        entity_id: input_select.sonos
        option: "Play Smooth Jazz Station"
        
        ##########################################################
        ## Play Top Hip-hop Station
        ##########################################################

- alias: Media - Play Top Hip-hop Station

  trigger:
    - platform: state
      entity_id: input_boolean.hiphop_station
      from: 'off'
      to: 'on'

  condition:
    - condition: state
      entity_id: group.household
      state: 'home'

  action:
    - service: media_player.sonos_join
      data:
        master: media_player.chalkboard_room
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
    - delay: '00:00:02'
    - service: media_player.volume_set
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
      data:
        volume_level: '.4'
    - delay: '00:00:01'
    - service: media_player.select_source
      data:
        entity_id: media_player.chalkboard_room
        source: 'Top Hip-Hop'
    - service: homeassistant.turn_off
      entity_id:
        - input_boolean.90_station
        - input_boolean.classical_station
        - input_boolean.kids_station
        - input_boolean.jazz_station
        - input_boolean.pop_station
        - input_boolean.caffeine_playlist
        - input_boolean.coffee_shop_playlist
        - input_boolean.dubstep_playlist
    - service: input_select.select_option
      data:
        entity_id: input_select.sonos
        option: "Play Top Hip-hop Station"
        
        ##########################################################
        ## Play Top Pop Station
        ##########################################################

- alias: Media - Play Top Pop Station

  trigger:
    - platform: state
      entity_id: input_boolean.pop_station
      from: 'off'
      to: 'on'

  condition:
    - condition: state
      entity_id: group.household
      state: 'home'

  action:
    - service: media_player.sonos_join
      data:
        master: media_player.chalkboard_room
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
    - delay: '00:00:02'
    - service: media_player.volume_set
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
      data:
        volume_level: '.4'
    - delay: '00:00:01'
    - service: media_player.select_source
      data:
        entity_id: media_player.chalkboard_room
        source: 'Top Pop'
    - service: homeassistant.turn_off
      entity_id:
        - input_boolean.90_station
        - input_boolean.classical_station
        - input_boolean.kids_station
        - input_boolean.jazz_station
        - input_boolean.hiphop_station
        - input_boolean.caffeine_playlist
        - input_boolean.coffee_shop_playlist
        - input_boolean.dubstep_playlist
    - service: input_select.select_option
      data:
        entity_id: input_select.sonos
        option: "Play Top Pop Station"
        
        ##########################################################
        ## Play Caffeine for Your Ears Playlist
        ##########################################################

- alias: Media - Play Caffeine for Your Ears Playlist

  trigger:
    - platform: state
      entity_id: input_boolean.caffeine_playlist
      from: 'off'
      to: 'on'

  condition:
    - condition: state
      entity_id: group.household
      state: 'home'

  action:
    - service: media_player.sonos_join
      data:
        master: media_player.chalkboard_room
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
    - delay: '00:00:02'
    - service: media_player.volume_set
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
      data:
        volume_level: '.4'
    - delay: '00:00:01'
    - service: media_player.select_source
      data:
        entity_id: media_player.chalkboard_room
        source: 'Caffeine for Your Ears'
    - service: homeassistant.turn_off
      entity_id:
        - input_boolean.90_station
        - input_boolean.classical_station
        - input_boolean.kids_station
        - input_boolean.jazz_station
        - input_boolean.hiphop_station
        - input_boolean.pop_station
        - input_boolean.coffee_shop_playlist
        - input_boolean.dubstep_playlist
    - service: input_select.select_option
      data:
        entity_id: input_select.sonos
        option: "Play Caffeine for Your Ears Playlist"
        
        ##########################################################
        ## Play Coffee Shop Pop Playlist
        ##########################################################

- alias: Media - Play Coffee Shop Pop Playlist

  trigger:
    - platform: state
      entity_id: input_boolean.coffee_shop_playlist
      from: 'off'
      to: 'on'

  condition:
    - condition: state
      entity_id: group.household
      state: 'home'

  action:
    - service: media_player.sonos_join
      data:
        master: media_player.chalkboard_room
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
    - delay: '00:00:02'
    - service: media_player.volume_set
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
      data:
        volume_level: '.4'
    - delay: '00:00:01'
    - service: media_player.select_source
      data:
        entity_id: media_player.chalkboard_room
        source: 'Coffee Shop Pop'
    - service: homeassistant.turn_off
      entity_id:
        - input_boolean.90_station
        - input_boolean.classical_station
        - input_boolean.kids_station
        - input_boolean.jazz_station
        - input_boolean.hiphop_station
        - input_boolean.pop_station
        - input_boolean.caffeine_playlist
        - input_boolean.dubstep_playlist
    - service: input_select.select_option
      data:
        entity_id: input_select.sonos
        option: "Play Coffee Shop Pop Playlist"   

        
        ##########################################################
        ## Play Devastating Dubstep Drops Playlist
        ##########################################################

- alias: Media - Play Devastating Dubstep Drops Playlist

  trigger:
    - platform: state
      entity_id: input_boolean.dubstep_playlist
      from: 'off'
      to: 'on'

  condition:
    - condition: state
      entity_id: group.household
      state: 'home'

  action:
    - service: media_player.sonos_join
      data:
        master: media_player.chalkboard_room
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
    - delay: '00:00:02'
    - service: media_player.volume_set
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
      data:
        volume_level: '.4'
    - delay: '00:00:01'
    - service: media_player.select_source
      data:
        entity_id: media_player.chalkboard_room
        source: 'Devastating Dubstep Drops'
    - service: homeassistant.turn_off
      entity_id:
        - input_boolean.90_station
        - input_boolean.classical_station
        - input_boolean.kids_station
        - input_boolean.jazz_station
        - input_boolean.hiphop_station
        - input_boolean.pop_station
        - input_boolean.caffeine_playlist
        - input_boolean.coffee_shop_playlist
    - service: input_select.select_option
      data:
        entity_id: input_select.sonos
        option: "Play Devastating Dubstep Drops Playlist"
        
        ##########################################################
        ## Sonos start activity from input select All '90s
        ##########################################################

- alias: Media - Sonos start activity from input select All '90s

  trigger:
    - platform: state
      entity_id: input_select.sonos
      to: "Play All '90s Station"

  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.90_station
      
        ##########################################################
        ## Sonos start activity from input select Classical
        ##########################################################

- alias: Media - Sonos start activity from input select Classical

  trigger:
    - platform: state
      entity_id: input_select.sonos
      to: 'Play Classical Station'

  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.classical_station
      
        ##########################################################
        ## Sonos start activity from input select Kids
        ##########################################################

- alias: Media - Sonos start activity from input select Kids

  trigger:
    - platform: state
      entity_id: input_select.sonos
      to: "Play Little Kids Station"

  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.kids_station
      
        ##########################################################
        ## Sonos start activity from input select Jazz
        ##########################################################

- alias: Media - Sonos start activity from input select Jazz

  trigger:
    - platform: state
      entity_id: input_select.sonos
      to: 'Play Smooth Jazz Station'

  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.jazz_station
      
        ##########################################################
        ## Sonos start activity from input select Hiphop
        ##########################################################

- alias: Media - Sonos start activity from input select Hiphop

  trigger:
    - platform: state
      entity_id: input_select.sonos
      to: 'Play Top Hip-hop Station'

  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.hiphop_station
      
        ##########################################################
        ## Sonos start activity from input select Pop
        ##########################################################

- alias: Media - Sonos start activity from input select Pop

  trigger:
    - platform: state
      entity_id: input_select.sonos
      to: 'Play Top Pop Station'

  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.pop_station
      
        ##########################################################
        ## Sonos start activity from input select Caffeine
        ##########################################################

- alias: Media - Sonos start activity from input select Caffeine

  trigger:
    - platform: state
      entity_id: input_select.sonos
      to: 'Play Caffeine for Your Ears Playlist'

  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.caffeine_playlist
      
        ##########################################################
        ## Sonos start activity from input select Coffee Shop
        ##########################################################

- alias: Media - Sonos start activity from input select Coffee Shop

  trigger:
    - platform: state
      entity_id: input_select.sonos
      to: 'Play Coffee Shop Pop Playlist'

  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.coffee_shop_playlist
      
        ##########################################################
        ## Sonos start activity from input select Dubstep
        ##########################################################

- alias: Media - Sonos start activity from input select Dubstep

  trigger:
    - platform: state
      entity_id: input_select.sonos
      to: 'Play Devastating Dubstep Drops Playlist'

  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.dubstep_playlist
      
        ##########################################################
        ## Sonos stop activity from input select Off
        ##########################################################

- alias: Media - Sonos stop activity from input select Off

  trigger:
    - platform: state
      entity_id: input_select.sonos
      to: 'None'

  action:
    - service: media_player.media_stop
      entity_id:
        - media_player.chalkboard_room
        - media_player.kitchen
        - media_player.loft
          
        ##########################################################
        ## LGTV Ring Notification
        ##########################################################
          
- alias: Notification Living Room TV - Front Door Motion
  trigger:
    - platform: state
      entity_id: binary_sensor.ring_front_door_motion
      to: 'on'
  condition:
    condition: template
    value_template: '{{ states.remote.media_center.state != "off" }}'
  action:
    - service: notify.livingroom_tv
      data:
        message: "Motion detected: Front Door"
        
- alias: Notification Living Room TV - Front Door Ring
  trigger:
    - platform: state
      entity_id: binary_sensor.ring_front_door_ding
      to: 'on'
  condition:
    condition: template
    value_template: '{{ states.remote.media_center.state != "off" }}'
  action:
    - service: notify.livingroom_tv
      data:
        message: "Doorbell pressed: Front Door"
        
        
        ##########################################################
        ## Lights
        ##########################################################
        
- alias: Lights - Exterior lights on 5min before sunset
  trigger:
    - platform: sun
      event: sunset
      offset: "-00:05:00"
  condition:
    - condition: state
      entity_id: input_boolean.disable_exterior_on_sunset
      state: 'off'
  action:
    - service: light.turn_on
      entity_id: group.exterior_lights
      data:
        brightness: 254
      
- alias: Lights - Exterior lights dim at 9:00pm
  trigger:
    - platform: time
      at: '21:00:00'
  condition:
    - condition: state
      entity_id: input_boolean.disable_exterior_dim_9pm
      state: 'off'
  action:
    - service: light.turn_on
      entity_id: group.exterior_lights
      data:
        transition: 60
        brightness: 85  
      
- alias: Lights - Exterior lights off 30min after sunrise
  trigger:
    - platform: sun
      event: sunrise
      offset: "00:30:00"
  condition:
    - condition: state
      entity_id: input_boolean.disable_exterior_off_sunrise
      state: 'off'
  action:
    - service: light.turn_off
      entity_id: group.exterior_lights
      data:
        transition: 60
        
- alias: Lights - Interior Loft Turn on 30% at Sunset if Home
  trigger:
    - platform: sun
      event: sunset
      offset: "-00:01:00"
  condition:
    - condition: state
      entity_id: input_boolean.disable_loft_on_sunset
      state: 'off'
    - condition: state
      entity_id: group.household
      state: 'home'      
  action:
    - service: light.turn_on
      entity_id: group.loft_lights
      data:
        brightness: 75
        transition: 5        

- alias: Lights - Interior Loft Turn off at 8:10PM
  trigger:
    - platform: time
      at: '20:10:00'
  condition:
    - condition: state
      entity_id: input_boolean.disable_loft_off_8pm
      state: 'off'     
  action:
    - service: light.turn_off
      entity_id: group.loft_lights
      data:
       transition: 60            
        
        ##########################################################
        ## Doorbell
        ##########################################################
        
- alias: Doorbell - Turn Exterior Lights to 100% when Rung after 9PM
  trigger:
    - platform: state
      entity_id: binary_sensor.ring_front_door_ding
      from: 'off'
      to: 'on'
  condition:
    - condition: time
      after: '21:00:00'
    - condition: state
      entity_id: sun.sun
      state: 'below_horizon'
  action:
    - service: light.turn_on
      entity_id: group.exterior_lights
      data:
        brightness: 254
        
- alias: Doorbell - Reset Exterior Lights to 35% after Ring after 9PM
  trigger:
    - platform: state
      entity_id: binary_sensor.ring_front_door_ding
      from: 'on'
      to: 'off'
      for:
        hours: 0
        minutes: 30
        seconds: 0
  condition:
    - condition: time
      after: '21:00:00'
    - condition: state
      entity_id: sun.sun
      state: 'below_horizon'
  action:
    - service: light.turn_on
      entity_id: group.exterior_lights
      data:
        brightness: 85
        transition: 60
        
- alias: Doorbell - Turn Exterior Lights to 100% when Motion Detected after 9PM
  trigger:
    - platform: state
      entity_id: binary_sensor.ring_front_door_motion
      from: 'off'
      to: 'on'
  condition:
    - condition: time
      after: '21:00:00'
    - condition: state
      entity_id: sun.sun
      state: 'below_horizon'
  action:
    - service: light.turn_on
      entity_id: group.exterior_lights
      data:
        brightness: 254
        
- alias: Doorbell - Reset Exterior Lights to 35% after Motion Detected after 9PM
  trigger:
    - platform: state
      entity_id: binary_sensor.ring_front_door_motion
      from: 'on'
      to: 'off'
      for:
        hours: 0
        minutes: 30
        seconds: 0
  condition:
    - condition: time
      after: '21:00:00'
    - condition: state
      entity_id: sun.sun
      state: 'below_horizon'
  action:
    - service: light.turn_on
      entity_id: group.exterior_lights
      data:
        brightness: 85
        transition: 60
      
      #################################################################
      ## Remote
      #################################################################

- alias: Media - Media Center remote external update Media Center
  trigger:
    - platform: state
      entity_id: remote.media_center
  action:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.remote
        option: >
          {{ states.remote.media_center.attributes.current_activity }}
          
- alias: Media - Master remote external update Media Center
  trigger:
    - platform: state
      entity_id: remote.master
  action:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.master_remote
        option: >
          {{ states.remote.master.attributes.current_activity }}
          
          
- alias: Media - Media center remote start activity from input select media center
  trigger:
    - platform: state
      entity_id: input_select.remote
  action:
    - service: script.turn_on
      entity_id: script.input_select_harmony
      
- alias: Media - Master remote start activity from input select media center
  trigger:
    - platform: state
      entity_id: input_select.master_remote
  action:
    - service: script.turn_on
      entity_id: script.input_select_master_harmony
      
- alias: Media - Spam TV PowerOn
  trigger:
    - platform: state
      entity_id: remote.media_center
      from: 'off'
      to: 'on'
  action:
    - service: remote.send_command
      data_template:
        entity_id: remote.media_center
        command: 'PowerOn'
        device: 35212312     
    - service: remote.send_command
      data_template:
        entity_id: remote.media_center
        command: 'PowerOn'
        device: 35212312  
    - service: remote.send_command
      data_template:
        entity_id: remote.media_center
        command: 'PowerOn'
        device: 35212312  
    - service: remote.send_command
      data_template:
        entity_id: remote.media_center
        command: 'PowerOn'
        device: 35212312  
    - service: remote.send_command
      data_template:
        entity_id: remote.media_center
        command: 'PowerOn'
        device: 35212312          
      
      #################################################################
      ## Occupancy
      #################################################################
      
- alias: Occupancy - Office turn on if motion detected
  trigger:
    - platform: state
      entity_id: sensor.office_pir
      from: 'standby'
      to: 'motion detected'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.office_occupancy
      
- alias: Occupancy - Office turn off after 30min of no motion
  trigger:
    - platform: state
      entity_id: sensor.office_pir
      to: 'standby'
      for:
        minutes: 30
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.office_occupancy
      
- alias: Occupancy - Living turn on if motion detected
  trigger:
    - platform: state
      entity_id: sensor.living_room_motion_detected
      from: 'False'
      to: 'True'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.living_occupancy
      
- alias: Occupancy - Living turn off after 30min of no motion
  trigger:
    - platform: state
      entity_id: sensor.living_room_motion_detected
      to: 'False'
      for:
        minutes: 30
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.living_occupancy

- alias: Occupancy - Garage turn on if motion detected
  trigger:
    - platform: state
      entity_id: sensor.garage_motion_detected
      from: 'False'
      to: 'True'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.garage_occupancy
      
- alias: Occupancy - Garage turn off after 10min of no motion
  trigger:
    - platform: state
      entity_id: sensor.garage_motion_detected
      to: 'False'
      for:
        minutes: 10
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.garage_occupancy   

- alias: Occupancy - Chalkboard turn on if motion detected
  trigger:
    - platform: state
      entity_id: sensor.chalkboard_room_motion_detected
      from: 'False'
      to: 'True'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.chalkboard_occupancy
      
- alias: Occupancy - Chalkboard turn off after 30min of no motion
  trigger:
    - platform: state
      entity_id: sensor.chalkboard_room_motion_detected
      to: 'False'
      for:
        minutes: 30
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.chalkboard_occupancy 

- alias: Occupancy - Shop turn on if motion detected
  trigger:
    - platform: state
      entity_id: sensor.shop_motion_detected
      from: 'False'
      to: 'True'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.shop_occupancy
      
- alias: Occupancy - Shop turn off after 10min of no motion
  trigger:
    - platform: state
      entity_id: sensor.shop_motion_detected
      to: 'False'
      for:
        minutes: 10
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.shop_occupancy      
      
        ##########################################################
        ## Turn on Vacation Mode when Gone 24 Hours
        ##########################################################

- alias: Vacation - Turn on when Gone 24 Hours
  trigger:
    - platform: state
      entity_id: group.household
      from: 'home'
      to: 'not_home'
      for:
        hours: 24
        minutes: 0
        seconds: 0
  condition:
    - condition: state
      entity_id: input_boolean.disable_home_away
      state: 'off'
  action:
    - service: homeassistant.turn_on
      entity_id: input_boolean.vacation_mode
      
        ##########################################################
        ## Turn off Vacation Mode when Home
        ##########################################################

- alias: Vacation - Turn off when Home
  trigger:
    - platform: state
      entity_id: group.household
      from: 'not_home'
      to: 'home'
  condition:
    - condition: state
      entity_id: input_boolean.disable_home_away
      state: 'off'
  action:
    - service: homeassistant.turn_off
      entity_id: input_boolean.vacation_mode
      
        ##########################################################
        ## New version of Home Assistant
        ##########################################################

- alias: Updater - New Version of Home Assistant
  trigger:
    - platform: state
      entity_id: sensor.current_ha_release
  action:
    - service: notify.pushbullet
      data:
        title: "New Home Assistant Release"
        message: "Home Assistant {{ states.sensor.current_ha_release.state }} is now available."
        
        ##########################################################
        ## Set Nest to Away if Vacation Mode is On
        ##########################################################

- alias: Climate - Set Nest to Away in Vacation Mode
  trigger:
    - platform: state
      entity_id: input_boolean.vacation_mode
      from: 'off'
      to: 'on'
  action:
    - service: climate.set_away_mode
      entity_id: climate.downstairs
      data:
        away_mode: 'True'      
    - service: climate.set_away_mode
      entity_id: climate.upstairs
      data:
        away_mode: 'True'  

        ##########################################################
        ## Set Nest to Home if Vacation Mode is Off
        ##########################################################

- alias: Climate - Set Nest to Home if Vacation Mode Turns Off
  trigger:
    - platform: state
      entity_id: input_boolean.vacation_mode
      from: 'on'
      to: 'off'
  action:
    - service: climate.set_away_mode
      entity_id: climate.downstairs
      data:
        away_mode: 'False'      
    - service: climate.set_away_mode
      entity_id: climate.upstairs
      data:
        away_mode: 'False'          

        ##########################################################
        ## Notify if Nest has gone into Away Mode
        ##########################################################

- alias: Climate - Nest has gone into away mode
  trigger:
    - platform: state
      entity_id: sensor.downstairs_thermostat_away_mode
      from: 'off'
      to: 'on'
    - platform: state
      entity_id: sensor.upstairs_thermostat_away_mode
      from: 'off'
      to: 'on'  
  condition:
    - condition: state
      entity_id: sensor.downstairs_thermostat_away_mode
      state: 'on'
    - condition: state
      entity_id: sensor.upstairs_thermostat_away_mode
      state: 'on'
  action:
    - service: notify.pushbullet
      data:
        title: "Home Assistant"
        message: "Nests have entered away mode"
        
        ##########################################################
        ## Notify if Nest has gone into Home Mode
        ##########################################################

- alias: Climate - Nest has gone into home mode
  trigger:
    - platform: state
      entity_id: sensor.downstairs_thermostat_away_mode
      from: 'on'
      to: 'off'
    - platform: state
      entity_id: sensor.upstairs_thermostat_away_mode
      from: 'on'
      to: 'off'
  condition:
    - condition: state
      entity_id: sensor.downstairs_thermostat_away_mode
      state: 'off'
    - condition: state
      entity_id: sensor.upstairs_thermostat_away_mode
      state: 'off'
  action:
    - service: notify.pushbullet
      data:
        title: "Home Assistant"
        message: "Nests have exited away mode"
        
        ##########################################################
        ## Run Cox Usage Script Hourly
        ##########################################################

- alias: Query Cox Data Usage
  trigger:
    platform: time
    minutes: '/60'
    seconds: 00
  action:
    service: shell_command.query_cox_data_usage
    
        ##########################################################
        ## Notify if critical device goes offline
        ##########################################################
        
- alias: Alert when a critical device goes offline
  trigger:
    - platform: state
      entity_id:
      - binary_sensor.synology_nas
      - binary_sensor.qnap_nas
      - binary_sensor.hue_hub
      - binary_sensor.harmony_hub
      - binary_sensor.master_harmony_hub      
      - binary_sensor.sonos_chalkboard
      - binary_sensor.sonos_den    
      - binary_sensor.sonos_kitchen
      - binary_sensor.ring_pro   
      - binary_sensor.opensprinkler_pi
      - binary_sensor.upstairs_thermostat_online
      - binary_sensor.downstairs_thermostat_online
      - binary_sensor.baby_camera
      - binary_sensor.living_camera
      - binary_sensor.chalkboard_camera
      - binary_sensor.garage_camera
      - binary_sensor.shop_camera
      from: 'on'
      to: 'off'
      for:
        minutes: 2
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {% if states.automation.alert_when_a_critical_device_goes_offline.last_triggered is not none %}
            {% if as_timestamp(now()) | int   -  as_timestamp(states.automation.alert_when_a_critical_device_goes_offline.attributes.last_triggered) | int > 3600 %} true {% else %} false
            {% endif %}
          {% else %}
          false
          {% endif %}
  action:
    - service: notify.pushbullet
      data_template:
        title: "Home Assistant - Device Alert"
        message: '{{trigger.to_state.attributes.friendly_name}} has gone offline.'
        
        ##########################################################
        ## Sleep Time
        ##########################################################
        
- alias: SleepTime
  trigger:
    - platform: state
      entity_id: input_boolean.sleep_time
      to: 'on'
      for:
        hours: 0
        minutes: 1
        seconds: 0
  action:
    - delay: '00:30:00'
    - service: input_select.select_option
      data:
        entity_id: input_select.master_remote
        option: PowerOff   
        
- alias: SleepTime Reset
  trigger:
    - platform: state
      entity_id: input_boolean.sleep_time
      to: 'on'
      for:
        hours: 0
        minutes: 31
        seconds: 0
  action:
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.sleep_time
